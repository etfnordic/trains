<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tågkarta</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; width: 100%; }
    .hud {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 10px 12px;
      border-radius: 10px;
      font: 14px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      max-width: 360px;
    }
    .hud small { opacity: 0.85; display: block; margin-top: 6px; }
    .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      margin-left: 8px;
      font-size: 12px;
    }
    .leaflet-container { background: #0b1220; }

    /* SVG-markören (wrapper) */
    .train-icon {
      width: 26px;
      height: 26px;
      transform-origin: 50% 50%;
      will-change: transform;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.45));
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="hud" id="hud">
    <div>
      <strong>Tågpositioner</strong>
      <span class="chip" id="count">–</span>
    </div>
    <small id="status">Startar…</small>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // === Konfiguration ===
    const WORKER_URL = "https://trains.etfnordic.workers.dev/trains?minutes=30&activeOnly=true";
    const REFRESH_MS = 15000; // 15s
    const MAX_STALE_MS = 30 * 60 * 1000; // säkerhetscheck även i frontend

    // === Karta ===
    const map = L.map("map", { zoomControl: true }).setView([62.0, 15.0], 5);

    // OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap-bidragsgivare"
    }).addTo(map);

    // trainId -> marker
    const markers = new Map();

    // --- Helpers ---
    function parseWGS84Point(wgs84) {
      // "POINT (14.553827774073737 56.895264515729586)" => [lat, lon]
      const m = /^POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)$/.exec(String(wgs84 || "").trim());
      if (!m) return null;
      const lon = Number(m[1]);
      const lat = Number(m[2]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return [lat, lon];
    }

    function trainId(tp) {
      // stabilt id: advertised + departuredate (om finns)
      const adv = tp?.Train?.AdvertisedTrainNumber ?? "";
      const dep = tp?.Train?.OperationalTrainDepartureDate ?? "";
      return `${adv}__${dep}`;
    }

    function displayName(tp) {
      return tp?.Train?.AdvertisedTrainNumber ?? tp?.Train?.OperationalTrainNumber ?? "Okänt";
    }

    function makeArrowSvg() {
      // Enkel pil som pekar "upp" (0°). Vi roterar wrappern enligt Bearing.
      // Färgen kan du ändra i fill/stroke om du vill.
      return `
        <svg class="train-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M32 4 L44 28 L36 28 L36 60 L28 60 L28 28 L20 28 Z"
                fill="white" stroke="black" stroke-width="2" stroke-linejoin="round"/>
        </svg>
      `;
    }

    function makeDivIcon(bearingDeg) {
      const html = `<div style="transform: rotate(${bearingDeg || 0}deg);">${makeArrowSvg()}</div>`;
      return L.divIcon({
        html,
        className: "", // vi vill inte Leaflets default class
        iconSize: [26, 26],
        iconAnchor: [13, 13],
      });
    }

    function setHud(text, count) {
      document.getElementById("status").textContent = text;
      if (typeof count === "number") {
        document.getElementById("count").textContent = `${count} tåg`;
      }
    }

    async function fetchAndRender() {
      try {
        setHud("Hämtar…");
        const res = await fetch(WORKER_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const trains = data?.trains ?? [];
        const now = Date.now();

        // håll koll på vilka som finns i nya payloaden
        const seen = new Set();

        for (const tp of trains) {
          const id = trainId(tp);
          const name = displayName(tp);
          const pos = parseWGS84Point(tp?.Position?.WGS84);
          const bearing = Number(tp?.Bearing ?? 0);
          const ts = Date.parse(tp?.TimeStamp);

          if (!id || !pos) continue;
          if (!Number.isFinite(ts) || (now - ts) > MAX_STALE_MS) continue;

          seen.add(id);

          const popupHtml = `
            <div style="font: 14px/1.3 system-ui, sans-serif;">
              <div><strong>Tåg ${name}</strong></div>
              <div>Riktning: ${Number.isFinite(bearing) ? bearing : "–"}°</div>
              <div>TimeStamp: ${tp?.TimeStamp ?? "–"}</div>
            </div>
          `;

          if (!markers.has(id)) {
            const marker = L.marker(pos, {
              icon: makeDivIcon(bearing),
              riseOnHover: true
            }).addTo(map);

            marker.bindPopup(popupHtml);
            markers.set(id, marker);
          } else {
            const marker = markers.get(id);
            marker.setLatLng(pos);
            marker.setIcon(makeDivIcon(bearing));
            marker.setPopupContent(popupHtml);
          }
        }

        // ta bort markers som inte längre finns
        for (const [id, marker] of markers.entries()) {
          if (!seen.has(id)) {
            map.removeLayer(marker);
            markers.delete(id);
          }
        }

        const fetchedAt = data?.meta?.fetchedAt ? new Date(data.meta.fetchedAt).toLocaleString() : "okänt";
        setHud(`Uppdaterad: ${fetchedAt}`, trains.length);
      } catch (err) {
        setHud(`Fel vid hämtning: ${err?.message || err}`);
        console.error(err);
      }
    }

    // start
    fetchAndRender();
    setInterval(fetchAndRender, REFRESH_MS);
  </script>
</body>
</html>
